---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r message=F, warning=F, echo=F}
library(reshape2)
library(dplyr)
library(ggplot2)
```

From [538 Riddler](https://fivethirtyeight.com/features/can-you-find-the-best-dungeons-dragons-strategy/)

> The fifth edition of Dungeons & Dragons introduced a system
> of “advantage and disadvantage.” When you roll a die “with
> advantage,” you roll the die twice and keep the higher result. Rolling
> “with disadvantage” is similar, except you keep the lower result
> instead. The rules further specify that when a player rolls with both
> advantage and disadvantage, they cancel out, and the player rolls a
> single die. Yawn!
> 
> There are two other, more mathematically interesting ways that advantage
> and disadvantage could be combined. First, you could have “advantage of
> disadvantage,” meaning you roll twice with disadvantage and then keep
> the higher result. Or, you could have “disadvantage of advantage,”
> meaning you roll twice with advantage and then keep the lower result. With
> a fair 20-sided die, which situation produces the highest expected
> roll: advantage of disadvantage, disadvantage of advantage or rolling
> a single die?
> 
> Extra Credit: Instead of maximizing your expected roll, suppose you
> need to roll N or better with your 20-sided die. For each value of N,
> is it better to use advantage of disadvantage, disadvantage of advantage
> or rolling a single die?

First I'll have a look at the conventional rolls: rolling a single die, rolling with advantage, rolling with disadvantage.

```{r}
N <- 1000000
roll1 <- sample(1:20, N, replace=T)
roll2 <- sample(1:20, N, replace=T)
raw_rolls <- data.frame(advantage=pmax(roll1, roll2), single=roll1, disadvantage=pmin(roll1, roll2))
summary(raw_rolls)
```

The mean of the single roll is close to the expected 10.5. I'm not sure what I expect for advantage and disadvantage rolls, beyond the simple intuition that they are better/worse than a single roll, and that checks out here, with about 13.8 for advantage, 7.2 for disadvantage.

How about a visualization? A histogram of the simulation results will approximate the probability mass functions. 

```{r}
rolls <- melt(raw_rolls, id.vars=NULL)
names(rolls) <- c("type", "roll")
# re-order the factor so the graph is ordered left-to-right, best-to-worst
rolls$type <- factor(rolls$type, levels=c("advantage", "single", "disadvantage"))
roll_pmf <- rolls %>% group_by(type, roll) %>% summarize(count=n()) %>% mutate(frequency=count/sum(count))

p <- ggplot(roll_pmf, aes(x=roll, y=frequency, fill=type)) +
  geom_bar(stat="identity", show.legend=F) +
  scale_x_continuous(breaks=c(1, 5, 10, 15, 20))
p + facet_grid(. ~ type)
```

Interesting: the most likely result on an advantage roll is 20, and on a disadvantage roll it's 1.

Another way to look at the probabilties is with a boxplot. This shows the median, 25th, and 75th percentile. A diamond shows the expected value.

```{r}
ggplot(rolls, aes(type, roll, color=type)) +
  geom_boxplot(show.legend=F) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=3, show.legend=F) +
  scale_y_continuous(breaks=c(1, 5, 10, 15, 20))
```

Enough tinkering! For an advantage of disadvantage roll, you roll with disadvantage twice, and take the max. That's 4 single rolls. Disadvantage
of advantage is the same, with disadvantage and advantage, min and max swapped.

I'll do 4 single rolls, and then reduce them down in two different ways to do advantage of disadvantage, and disadvantage of advantage. I'll keep the first single roll for comparison against the other two distributions.

```{r}
roll1 <- sample(1:20, N, replace=T)
roll2 <- sample(1:20, N, replace=T)
roll3 <- sample(1:20, N, replace=T)
roll4 <- sample(1:20, N, replace=T)
raw_rolls <- data.frame(
  disadvantage_of_advantage=pmin(pmax(roll1, roll2), pmax(roll3, roll4)),
  single=roll1,
  advantage_of_disadvantage=pmax(pmin(roll1, roll2), pmin(roll3, roll4))
)
summary(raw_rolls)
```

Now I can answer the first question:

> With a fair 20-sided die, which situation produces the highest expected
> roll: advantage of disadvantage, disadvantage of advantage or rolling
> a single die?

Answer: disadvantage of advantage is best, with an expected value around 11.2. A single roll is the next best choice, with an expected value of 10.5. Last place goes to advantage of disadvantage, with an expected value around 9.8. 

Maybe the histograms show something more?

```{r}
rolls <- melt(raw_rolls, id.vars=NULL)
names(rolls) <- c("type", "roll")
# re-order the factor so the graph is ordered left-to-right, best-to-worst
rolls$type <- factor(rolls$type, levels=c("disadvantage_of_advantage", "single", "advantage_of_disadvantage"))

roll_pmf <- rolls %>% group_by(type, roll) %>% summarize(count=n()) %>% mutate(frequency=count/sum(count))

p <- ggplot(roll_pmf, aes(x=roll, y=frequency, fill=type)) +
  geom_bar(stat="identity", show.legend=F) +
  scale_x_continuous(breaks=c(1, 5, 10, 15, 20))
p + facet_grid(. ~ type)
```

These look like slightly-skewed bell curves.

Boxplots confirm the answer, and highlight how much closer all three choices are to one another, compared to conventional advantage and disadvantage rolls.

```{r}
ggplot(rolls, aes(type, roll, color=type)) +
  geom_boxplot(show.legend=F) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=3, show.legend=F) +
  scale_y_continuous(breaks=c(1, 5, 10, 15, 20))
```

